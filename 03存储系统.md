# 三、存储系统


## 3.1 存储器概述



### 3.1.1 存储系统的定义与功能
- **定义**：存储系统是计算机系统中用于存储程序和数据的部件，是计算机的重要组成部分
- **功能**：
  - 保存数据和程序
  - 提供数据的访问和修改能力
  - 在断电情况下能够保持数据的存储（针对非易失性存储）
  - 与CPU协同工作，形成完整的计算系统

### 3.1.2 存储器的层次结构
- **层次结构概念**：为了解决速度、成本和容量之间的矛盾，计算机系统采用多级存储层次
![alt text](image-1.png)
![alt text](image-2.png)

存储器层次结构的主要思想是**上一层的存储器作为低一层存储器的高速缓存**。当CPU要从存储器中存取数据时，先访间Cache，若不在Cache中，则访问主存，若不在主存中，则访问磁盘，此时，操作数从磁盘读出送到主存，然后从主存送到Cache。从CPU 的角度看，Cache-主存层的速度接近于Cache，容量和位价却接近于主存。从主存一辅存层分析，其速度接近于主存，容量和位价却接近于辅存。这就解决了速度、容量、成本这三者之间的矛盾。

**Cache-主存层主要解决CPU和主存速度不匹配的问题**，主存和Cache之间的数据调动是**由硬件自动完成**的，对所有程序员均是透明的。主存一辅存层主要解决存储系统的容量问题，主存和辅存之间的数据调动是**由硬件和操作系统共同完成**的，对应用程序员是透明的。

在主存-辅存层的不断发展中，逐渐形成了虚拟存储系统，在这个系统中程序员编程的地址范围与虚拟存储器的地址空间相对应，编程时可用的地址空间远大于主存空间。

**注意：在Cache-主存层和主存一辅存层中，上一层中的内容都只是下一层中的内容的副本，也即Cache（或主存）中的内容只是主存（或辅存）中的内容的一部分。**

### 3.1.3 存储器的分类
- **按存取方式分类**：
  - 随机存取存储器（RAM）：存储器的任何一个单元都可随机存取，存取时间与存储单元位置无关，**主要用作主存或高速缓冲存储器**。
  - 只读存储器（ROM）：存储器的内容在制造时已写入，用户只能读取，不能修改，**主要用作存放固化程序和数据**。也是随机存取的。可通过电擦除的方式写入。
  - 串行访问存储器：存储器的内容必须按顺序访问，**主要用作磁带等顺序存取设备**。
    - 顺序存取存储器（SAM）：如磁带，必须按顺序访问
    - 直接存取存储器（DAM）：如磁盘/光盘，可定位到大致位置后顺序访问
- **按存储介质分类**：
  - 半导体存储器：如RAM、ROM，cache，速度快，成本高
  - 磁表面存储器：如硬盘、磁带，容量大，成本低
  - 光学存储器：如CD、DVD，容量大，便携性
  - 磁芯存储器：早期存储器，现已基本淘汰

- **按信息保存方式分类**：
  - 易失性存储器：断电后信息丢失，如RAM
  - 非易失性存储器：断电后信息不丢失，如ROM、硬盘

> **相联存储器（Associative Memory）** 是一种按内容寻址的特殊存储器，它不依赖传统的地址来定位数据，而是通过数据的部分或全部内容直接检索并匹配目标信息，也常被称为内容寻址存储器（CAM，Content-Addressable Memory）。
> 
> 相联存储器是按内容寻址：用户输入待匹配的数据（或数据特征），存储器会并行检索所有存储单元，将每个单元的数据与输入内容比对，直接返回匹配成功的存储单元信息（如地址、完整数据）。
>
> **CPU 高速缓存（Cache）的地址映射** , 这是相联存储器最典型的应用。CPU 缓存的快表（TLB，转换检测缓冲区） 本质是小容量相联存储器，用于存储虚拟地址与物理地址的映射关系：
> + 当 CPU 访问内存时，会先将虚拟地址送入 TLB；
> + TLB 并行比对所有存储项的虚拟地址字段，若匹配成功则直接返回物理地址，避免了耗时的页表查询，大幅降低访存延迟。


### 3.1.4 存储系统的性能指标
存储器系统所追求的就是高容量、高速度、低成本和高可靠性，主要性能指标包括：
- **存储容量**：存储器可容纳的二进制信息量，**存储容量**=**地址线数量的2次方**（存储字数，表示存储器的地址空间大小）×**每个存储单元的位数**（存储字长，表示每个存储单元能存储的信息量，也表示一次存取的数据位数）
- **单位成本**：每位二进制位的平均价格，通常以美元/兆位（$ / Mb）表示
- **存取速度**：数据传输率=数据的宽度/存取周期
  - **存取时间（$T_a$）**：存取时间是指从CPU发出存储器请求到存储器完成数据传输所需的时间，包括寻址时间和传输时间,通常以纳秒（ns）为单位表示,分为读出时间和写入时间。
  - **存取周期（$T_m$）**：是指存储器进行一次完整的读/写操作所需要的完整时间，即连续两次独立访问存储器操作之间所需的最小时间间隔。
  ![alt text](image.png)
  - **主存带宽**：表示每秒钟主存能够传输的数据量，通常以MB/s或GB/s为单位
- **可靠性**：通常用MTBF（平均无故障时间）来衡量



## 3.2 主存储器


### 3.2.1 SRAM和DRAM
半导体存储器分为随机存储器（RAM）和只读存储器（ROM）。随机存储器（RAM）又分为**静态随机存取存储器（SRAM）** 和 **动态随机存取存储器（DRAM）**。主存储器主要采用DRAM，因为DRAM具有较高的存储密度和较低的成本，适合大容量存储需求，而SRAM则因其高速访问特性，主要用于CPU缓存（Cache）等对速度要求较高的场合。他们都是易失性存储器。ROM是非易失性存储器，主要用于存放固化程序和数据，如BIOS。

> **存储元**是物理基础，存储单元是逻辑集合。通常把存放一个二进制位的物理器件称为存储元，是存储器的最基本构件，是最小的、不可再分的存储单位；
> **存储单元**是由多个存储元组合而成的一个逻辑单位，它是CPU访问存储器（进行读/写操作）的基本单位。用于存储一个数据单元，这个数据单元通常是一个字节或其倍数（如字、双字等）。通常由 8个、16个、32个或64个存储元并排组成。


#### SRAM

**SRAM基本结构**
是由6个晶体管(6T)组成的存储元，由交叉耦合反相器结构形成双稳态电路，两个访问晶体管控制数据的读写

**SRAM工作原理**
- 数据存储原理
  - 交叉耦合的反相器组成的双稳态电路存储数据
  - 一个状态代表0，另一个状态代表1
- 读操作
  - 字线选通，位线预充电
  - 数据通过位线读取
  - 读取过程不破坏原有数据
- 写操作
  - 字线选通
  - 通过位线写入新数据
  - 强制改变交叉耦合反相器的状态

**SRAM特性**
- 优点
  - 读取速度快，不需要刷新
  - 非破坏性读出
  - 可靠性高
- 缺点
  - 单元面积大(约为DRAM的6-8倍)
  - 集成度低
  - 功耗较高
  - 价格昂贵，成本高
- 应用场景
  - CPU高速缓存
  - 寄存器
  - 小容量高速存储需求

#### DRAM 

**DRAM基本结构**
由1个晶体管和1个电容(1T1C)组成的存储元，电容存储电荷代表数据，晶体管作为开关控制电容的充放电

**DRAM工作原理**
- 数据存储原理
  - 电容中存储电荷代表数据(有电荷=1，无电荷=0)
  - 电容会自然放电，需要定期刷新
- 读操作
  - 字线选通，晶体管导通
  - 电容电荷传递到位线
  - 读取后电容放电(破坏性读出)，需要恢复
- 写操作
  - 字线选通，晶体管导通
  - 通过位线向电容充电或放电
  - 写入新数据

**DRAM特性**
- 优点
  - 单元面积小
  - 集成度高
  - 功耗低(静态时)
  - 成本低
- 缺点
  - 读取速度相对较慢
  - 需要定期刷新
  - 破坏性读出，需要恢复
  - 数据会随时间流失
- 应用场景
  - 主内存
  - 大容量存储需求
  - 低成本应用

#### SRAM与DRAM的比较

![alt text](image-3.jpg)
- 速度
  - SRAM访问速度快(通常1-10ns)
  - DRAM访问速度较慢(通常50-100ns)
- 带宽
  - SRAM带宽较高
  - DRAM带宽相对较低
- 功耗成本
  - SRAM静态功耗较高
  - DRAM静态功耗低，但有刷新功耗




#### 存储器芯片的内部结构

![alt text](image-4.jpg)

1. **存储体（存储矩阵）**。存储体是存储单元的集合，它由行选择线（X）和列选择线（Y）来选择所访问单元，存储体的相同行、列上的多位（位平面数）同时被读出或写入。
2. **地址译码器**。用来将地址转换为译码输出线上的高电平，以便驱动相应的读/写电路。地址译码有单译码法（一维译码）和双译码法（二维译码）两种方式。
   + 单译码法。只有一个行译码器，同一行中所有存储单元的字线连在一起，同一行中的各单元构成一个字，被同时读出或写入。缺点是地址译码器的输出线数过多。
   + 双译码法。如图3.5所示，地址译码器分为X和Y两个译码器，在选中的行和列交叉点上能确定一个存储单元，这是DRAM芯片目前普遍采用的译码结构。
3. **1/0电路**。用以控制被选中的单元的读出或写入，具有放大信号的作用。
4. **片选控制线**。单个芯片容量太小，往往满足不了计算机对存储器容量的要求，因此需用一定数量的芯片进行存储器的扩展。在访问某个字时，必须“选中”该存储字所在的芯片，而其他芯片不被“选中”，因此需要有片选控制信号（经片选控制线传输）。
5. **读/写控制线**。根据CPU给出的读命令或写命令，经读/写控制线控制被选中单元进行读或写。







### 3.2.2 只读存储器


#### 只读存储器的特点





#### ROM的类型






## 5. 存储器技术发展趋势
### 5.1 SRAM发展趋势
- 高速低功耗设计
- 新型材料应用
- 3D集成技术
- 近存储计算架构

### 5.2 DRAM发展趋势
- 高密度集成
- 宽位宽设计
- 低功耗技术
- 3D堆叠技术
- 新型存储电容结构

### 5.3 新型存储技术
- 3D XPoint技术
- ReRAM (电阻式随机存取存储器)
- MRAM (磁阻随机存取存储器)
- PCRAM (相变随机存取存储器)

## 3.3 主存储器与CPU的连接